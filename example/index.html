<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>Stencil Component Starter</title>
    <script type="module" src="/stripe-elements/stripe-elements.esm.js"></script>
    <script nomodule src="/stripe-elements/stripe-elements.js"></script>
  </head>
  <body>
        <form id="open-modal-form" name="open-modal-form">
            <div id="error-message"></div>
            <fieldset>
                <label>
                    <lenged>Stripe Publishable API Key</lenged>
                    <input name="stripe-publishable-api-key" type="text" />
                </label>
            </fieldset>
            <fieldset>
                <label>
                    <lenged>Payment Intent id</lenged>
                    <input name="payment-intent-id" type="text" />
                </label>
            </fieldset>
            <button type="submit">Launch</button>
        </form>
      <div id="stripe"></div>

    
    <script>
        const form = document.getElementById('open-modal-form')
        const errorMessage = document.getElementById('error-message')
        const targetElement = document.getElementById('stripe');
        const modalElement = document.createElement('stripe-element-modal');

        /**
         * Remove Mounted Stripe Elements when the modal has been closed
         **/
        customElements.whenDefined('stripe-element-modal')
            .then(() => {
                modalElement.addEventListener('close', () => {
                    modalElement.innerHTML = ''
                })
            })
        
        form.addEventListener('submit', async (event) => {
            event.preventDefault()
            const stripePublishableAPIKey = document['open-modal-form']['stripe-publishable-api-key'].value
            if (!stripePublishableAPIKey) {
                errorMessage.innerText = 'Stripe Publishable API Key is required'
                return
            }
            const paymentIntentId = document['open-modal-form']['payment-intent-id'].value
            /*
            if (!paymentIntentId) {
                errorMessage.innerText = 'Payment Intent Id is required'
                return
            }
            */

            /**
             * Define and launch Web Components
             **/
            const stripeElement = document.createElement('stripe-card-element');
            const stripePaymentRequestElement = document.createElement('stripe-payment-request-button');
            modalElement.appendChild(stripePaymentRequestElement);
            modalElement.appendChild(stripeElement);
            targetElement.appendChild(modalElement);

            /**
             * Wait for defining these components
             **/
            await customElements.whenDefined('stripe-element-modal')
            await customElements.whenDefined('stripe-payment-request-button')
            await customElements.whenDefined('stripe-card-element')
            
            /**
             * Load Stripe Client
             **/
            await stripePaymentRequestElement.initStripe(demoStripePublishableAPIKey)
            await stripeElement.initStripe(demoStripePublishableAPIKey)

            /**
             * Lauch Payment request button if possible to use
             **/
            const paymentRequest = await stripePaymentRequestElement.setPaymentRequestOption({
                country: 'JP',
                currency: 'jpy',
                total: {
                    label: 'Total',
                    amount: 100,
                },
                requestShipping: false,
                requestPayerEmail: false,
            });

            /**
             * Disable default form submit event
             **/
            stripeElement.setAttribute('should-use-default-form-submit-action', false);

            /**
             * Set custom form submit event manually
             **/
            stripeElement.addEventListener('formSubmit', async props => {
              const {
                detail: { stripe, cardNumber, event },
              } = props;
              const result = await stripe.createPaymentMethod({
                type: 'card',
                card: cardNumber,
              });
              stripeElement.updateProgress('success');
            });

            /**
             * Open modal
             **/
            modalElement.setAttribute('open', true)
        })
    </script>
    <style>
      body {
        background-color: #e5e5e5;
      }
    </style>
  </body>
</html>
